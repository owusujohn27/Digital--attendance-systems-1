// main.cpp
#include <iostream>
#include <vector>
#include <string>
#include <fstream>
#include <algorithm>
#include <iomanip>
#include <sstream>
#include <ctime>

using namespace std;

// Student Class
class Student {
private:
    string indexNumber;
    string name;
    string program;
    int year;

public:
    // Constructors
    Student() : year(0) {}
    
    Student(string idx, string n, string prog, int yr) {
        indexNumber = idx;
        name = n;
        program = prog;
        year = yr;
    }

    // Getters
    string getIndexNumber() const { return indexNumber; }
    string getName() const { return name; }
    string getProgram() const { return program; }
    int getYear() const { return year; }

    // Setters
    void setName(string n) { name = n; }
    void setProgram(string p) { program = p; }
    void setYear(int y) { year = y; }

    // Display student info
    void display() const {
        cout << "Index: " << indexNumber 
             << " | Name: " << name 
             << " | Program: " << program 
             << " | Year: " << year << endl;
    }

    // Convert to CSV string for file storage
    string toFileString() const {
        return indexNumber + "," + name + "," + program + "," + to_string(year);
    }

    // Create student from CSV string
    static Student fromFileString(const string& line) {
        stringstream ss(line);
        string idx, name, prog, yearStr;
        
        getline(ss, idx, ',');
        getline(ss, name, ',');
        getline(ss, prog, ',');
        getline(ss, yearStr, ',');
        
        return Student(idx, name, prog, stoi(yearStr));
    }
};

// Global vector to store students
vector<Student> students;

// Function prototypes
void displayMainMenu();
void studentManagementMenu();
void addStudent();
void viewAllStudents();
void searchStudent();
void loadStudentsFromFile();
void saveStudentsToFile();
void clearScreen();

// Clear screen function (works on Windows)
void clearScreen() {
    system("cls");
}

// Load students from file
void loadStudentsFromFile() {
    ifstream file("students.txt");
    if (!file.is_open()) {
        return; // File doesn't exist yet
    }
    
    students.clear();
    string line;
    while (getline(file, line)) {
        if (!line.empty()) {
            students.push_back(Student::fromFileString(line));
        }
    }
    file.close();
    cout << "Loaded " << students.size() << " students from file." << endl;
}

// Save students to file
void saveStudentsToFile() {
    ofstream file("students.txt");
    if (!file.is_open()) {
        cout << "Error: Could not save students to file!" << endl;
        return;
    }
    
    for (const auto& student : students) {
        file << student.toFileString() << endl;
    }
    file.close();
    cout << "Students saved successfully!" << endl;
}

// Add new student
void addStudent() {
    clearScreen();
    cout << "=== REGISTER NEW STUDENT ===\n" << endl;
    
    string index, name, program;
    int year;
    
    cout << "Enter Index Number: ";
    cin >> index;
    
    // Check if index already exists
    for (const auto& s : students) {
        if (s.getIndexNumber() == index) {
            cout << "Error: Student with this index number already exists!" << endl;
            cout << "\nPress Enter to continue...";
            cin.ignore();
            cin.get();
            return;
        }
    }
    
    cin.ignore(); // Clear buffer
    cout << "Enter Student Name: ";
    getline(cin, name);
    
    cout << "Enter Program (e.g., HND Electrical): ";
    getline(cin, program);
    
    cout << "Enter Year (1-3): ";
    cin >> year;
    
    students.push_back(Student(index, name, program, year));
    saveStudentsToFile();
    
    cout << "\nStudent registered successfully!" << endl;
    cout << "\nPress Enter to continue...";
    cin.ignore();
    cin.get();
}

// View all students
void viewAllStudents() {
    clearScreen();
    cout << "=== ALL REGISTERED STUDENTS ===\n" << endl;
    
    if (students.empty()) {
        cout << "No students registered yet." << endl;
    } else {
        cout << left << setw(15) << "Index No" 
             << setw(25) << "Name" 
             << setw(20) << "Program" 
             << setw(10) << "Year" << endl;
        cout << string(70, '-') << endl;
        
        for (const auto& student : students) {
            cout << left << setw(15) << student.getIndexNumber()
                 << setw(25) << student.getName()
                 << setw(20) << student.getProgram()
                 << setw(10) << student.getYear() << endl;
        }
    }
    
    cout << "\nTotal Students: " << students.size() << endl;
    cout << "\nPress Enter to continue...";
    cin.ignore();
    cin.get();
}

// Search student by index
void searchStudent() {
    clearScreen();
    cout << "=== SEARCH STUDENT ===\n" << endl;
    
    if (students.empty()) {
        cout << "No students registered yet." << endl;
        cout << "\nPress Enter to continue...";
        cin.ignore();
        cin.get();
        return;
    }
    
    string searchIndex;
    cout << "Enter Index Number to search: ";
    cin >> searchIndex;
    
    bool found = false;
    for (const auto& student : students) {
        if (student.getIndexNumber() == searchIndex) {
            cout << "\nStudent Found:\n";
            cout << string(30, '-') << endl;
            cout << "Index Number: " << student.getIndexNumber() << endl;
            cout << "Name: " << student.getName() << endl;
            cout << "Program: " << student.getProgram() << endl;
            cout << "Year: " << student.getYear() << endl;
            found = true;
            break;
        }
    }
    
    if (!found) {
        cout << "\nNo student found with index number: " << searchIndex << endl;
    }
    
    cout << "\nPress Enter to continue...";
    cin.ignore();
    cin.get();
}

// Student Management Menu
void studentManagementMenu() {
    int choice;
    
    do {
        clearScreen();
        cout << "=== STUDENT MANAGEMENT ===\n" << endl;
        cout << "1. Register New Student" << endl;
        cout << "2. View All Students" << endl;
        cout << "3. Search Student by Index" << endl;
        cout << "4. Back to Main Menu" << endl;
        cout << "\nEnter your choice (1-4): ";
        cin >> choice;
        
        switch (choice) {
            case 1:
                addStudent();
                break;
            case 2:
                viewAllStudents();
                break;
            case 3:
                searchStudent();
                break;
            case 4:
                cout << "Returning to main menu..." << endl;
                break;
            default:
                cout << "Invalid choice! Please try again." << endl;
                cout << "\nPress Enter to continue...";
                cin.ignore();
                cin.get();
        }
    } while (choice != 4);
}

// Main Menu
void displayMainMenu() {
    cout << "\n=== DIGITAL ATTENDANCE SYSTEM ===\n" << endl;
    cout << "1. Student Management" << endl;
    cout << "2. Attendance Session Management" << endl;
    cout << "3. Reports and Summary" << endl;
    cout << "4. Exit" << endl;
    cout << "\nEnter your choice (1-4): ";
}

// Main function
int main() {
    // Load students from file at startup
    loadStudentsFromFile();
    
    int choice;
    
    do {
        clearScreen();
        displayMainMenu();
        cin >> choice;
        
        switch (choice) {
            case 1:
                studentManagementMenu();
                break;
            case 2:
                // To be implemented in Week 2
                clearScreen();
                cout << "Attendance Session Management - Coming in Week 2!" << endl;
                cout << "\nPress Enter to continue...";
                cin.ignore();
                cin.get();
                break;
            case 3:
                // To be implemented in Week 3
                clearScreen();
                cout << "Reports and Summary - Coming in Week 3!" << endl;
                cout << "\nPress Enter to continue...";
                cin.ignore();
                cin.get();
                break;
            case 4:
                cout << "\nThank you for using Digital Attendance System!" << endl;
                break;
            default:
                cout << "Invalid choice! Please try again." << endl;
                cout << "\nPress Enter to continue...";
                cin.ignore();
                cin.get();
        }
    } while (choice != 4);
    
    return 0;
}
